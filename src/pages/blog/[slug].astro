---
import type { ImageMetadata } from 'astro';
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import TransmissionLink from '../../components/TransmissionLink.astro';
import TransmissionMessage from '../../components/TransmissionMessage.astro';
import dottePortrait from '../../images/dotte.png';
import mothershipPortrait from '../../images/mothership.png';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts
    .filter((post) => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props;
const { title, description, pubDate, tags, transmission } = post.data;
const { Content } = await post.render();

const placeholder = '<!-- transmission-link -->';
const hasTransmission = Boolean(transmission && post.body.includes(placeholder));
let introSegment = post.body;
let outroSegment = '';

if (hasTransmission) {
  const [before = '', after = ''] = post.body.split(placeholder);
  introSegment = before;
  outroSegment = after;
}

const escapeHtml = (value: string) =>
  value
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

const formatInline = (value: string) =>
  escapeHtml(value)
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>');

const segmentToHtml = (segment: string | undefined) => {
  if (!segment) return '';
  const lines = segment.split('\n');
  const blocks: string[] = [];
  let buffer: string[] = [];

  const flushParagraph = () => {
    if (buffer.length === 0) return;
    const text = buffer.join(' ').trim();
    if (text) {
      blocks.push(`<p>${formatInline(text)}</p>`);
    }
    buffer = [];
  };

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) {
      flushParagraph();
      continue;
    }
    if (trimmed.startsWith('## ')) {
      flushParagraph();
      blocks.push(`<h2>${formatInline(trimmed.slice(3).trim())}</h2>`);
      continue;
    }
    buffer.push(trimmed);
  }

  flushParagraph();
  return blocks.join('\n');
};

const firstSegmentHtml = hasTransmission ? segmentToHtml(introSegment) : '';
const secondSegmentHtml = hasTransmission ? segmentToHtml(outroSegment) : '';

const resolveImageSrc = (image: string | ImageMetadata) =>
  typeof image === 'string' ? image : image.src;

const transmissionLinkConfig = transmission
  ? {
      heading: transmission.heading,
      subheading: transmission.subheading,
      leftAgent: {
        name: 'D.O.T.T.E.',
        role: 'Field Observer',
        image: resolveImageSrc(dottePortrait),
        sizeClass: 'size-24',
      },
      rightAgent: {
        name: 'Mothership',
        role: 'Command Relay',
        image: resolveImageSrc(mothershipPortrait),
        sizeClass: 'size-24',
      },
    }
  : null;

const transmissionMessages =
  transmission?.messages.map((message) => ({
    speaker: message.speaker,
    content: formatInline(message.content.trim()),
  })) ?? [];
---

<Layout title={`${title} — Lincoln Report`} description={description}>
  <article class="post">
    <header>
      <p class="log-label">{`Field Report ${title.split(':')[0]?.replace('Log', '').trim() || ''}`}</p>
      <h1>{title}</h1>
      <time datetime={pubDate.toISOString()}>{pubDate.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
      })}</time>
      {tags.length > 0 && (
        <ul class="tag-list">
          {tags.map((tag) => (
            <li>{tag}</li>
          ))}
        </ul>
      )}
    </header>
    <div class="body">
      {hasTransmission && transmissionLinkConfig ? (
        <div class="transmission-stack">
          {firstSegmentHtml && <div set:html={firstSegmentHtml}></div>}
          <TransmissionLink
            heading={transmissionLinkConfig.heading}
            subheading={transmissionLinkConfig.subheading}
            leftAgent={transmissionLinkConfig.leftAgent}
            rightAgent={transmissionLinkConfig.rightAgent}
          >
            {transmissionMessages.map((message) => (
              <TransmissionMessage speaker={message.speaker} content={message.content} />
            ))}
          </TransmissionLink>
          {secondSegmentHtml && <div set:html={secondSegmentHtml}></div>}
        </div>
      ) : (
        <Content />
      )}
    </div>
    <footer class="post-footer">
      <a class="back" href="/blog">← Back to field reports</a>
    </footer>
  </article>
</Layout>

<style>
  .post {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 1.75rem;
    padding: clamp(1.75rem, 4vw, 3rem);
    display: grid;
    gap: 1.5rem;
    box-shadow: 0 28px 60px rgba(7, 10, 17, 0.45);
  }

  header {
    display: grid;
    gap: 0.75rem;
  }

  .log-label {
    margin: 0;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    font-size: 0.75rem;
    color: var(--accent);
  }

  h1 {
    margin: 0;
    font-size: clamp(2.1rem, 4vw, 2.8rem);
    line-height: 1.2;
  }

  time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--text-secondary);
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .tag-list li {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.3rem 0.65rem;
    border-radius: 999px;
    background: var(--accent-soft);
    color: var(--accent);
  }

  .body {
    display: grid;
    gap: 1rem;
    font-size: 1.05rem;
    line-height: 1.8;
    color: var(--text-secondary);
  }

  .transmission-stack {
    display: grid;
    gap: 1.5rem;
  }

  .body :global(p) {
    margin: 0;
  }

  .body :global(p + p) {
    margin-top: 0.75rem;
  }

  .post-footer {
    display: flex;
    justify-content: flex-end;
  }

  .back {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--accent);
    text-decoration: none;
  }

  .back:hover,
  .back:focus-visible {
    text-decoration: underline;
  }
</style>
